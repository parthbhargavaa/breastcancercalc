<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magee Equations Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .calculator-container { max-width: 800px; margin: 2rem auto; padding: 20px; }
        .form-group { margin-bottom: 1.2rem; }
        .result-alert { display: none; margin-top: 1.5rem; }
        input[type="number"] { max-width: 200px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Breast Cancer Calculators</a>
            <div class="navbar-nav">
                <a class="nav-link" href="magee.html">Magee</a>
                <a class="nav-link" href="hscore.html">H-Score</a>
                <a class="nav-link" href="npi.html">NPI</a>
                <a class="nav-link" href="pepi.html">PEPI</a>
            </div>
        </div>
    </nav>

    <div class="calculator-container">
        <h2>Magee Equations Calculator</h2>
        <p>Estimates Oncotype DX recurrence score using pathology data (ER-positive, HER2-negative breast cancer).</p>
        
        <form id="mageeForm">
            <div class="form-group">
                <label>Nottingham Score (3-9)</label>
                <input type="number" class="form-control" id="nottingham" min="3" max="9" step="1" required>
            </div>

            <div class="form-group">
                <label>ER H-Score (0-300)</label>
                <input type="number" class="form-control" id="erHScore" min="0" max="300" step="1" required>
            </div>

            <div class="form-group">
                <label>PR H-Score (0-300)</label>
                <input type="number" class="form-control" id="prHScore" min="0" max="300" step="1" required>
            </div>

            <div class="form-group">
                <label>HER2 Status</label>
                <select class="form-control" id="her2" required>
                    <option value="negative">Negative</option>
                    <option value="equivocal">Equivocal</option>
                    <option value="positive">Positive</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tumor Size (cm)</label>
                <input type="number" class="form-control" id="tumorSize" min="0.1" max="10.0" step="0.1" required>
            </div>

            <div class="form-group">
                <label>Ki-67 Percentage (0-100)</label>
                <input type="number" class="form-control" id="ki67" min="0" max="100" step="0.1" required>
            </div>

            <button type="button" class="btn btn-primary" onclick="calculateMagee()">Calculate</button>
        </form>

        <div class="result-alert alert alert-primary" role="alert">
            <h4>Average Magee Equation Score: <span id="averageScore">-</span></h4>
            <p class="mb-0">Interpretation: <span id="interpretation"></span></p>
        </div>

        <a href="https://path.upmc.edu/onlineTools/mageeequations.html" 
           class="btn btn-outline-secondary mt-3" 
           target="_blank">
            More Information About Magee Equations
        </a>
    </div>

    <script>
        function calculateMagee() {
            // Get input values with clamping to enforce limits
            const nottingham = Math.min(9, Math.max(3, parseFloat(document.getElementById('nottingham').value)));
            const erHScore = Math.min(300, Math.max(0, parseFloat(document.getElementById('erHScore').value)));
            const prHScore = Math.min(300, Math.max(0, parseFloat(document.getElementById('prHScore').value)));
            const tumorSize = Math.min(10, Math.max(0.1, parseFloat(document.getElementById('tumorSize').value)));
            const ki67 = Math.min(100, Math.max(0, parseFloat(document.getElementById('ki67').value)));
            
            // HER2 scoring
            const her2Scores = { negative: 0, equivocal: 0.5, positive: 1 };
            const her2Score = her2Scores[document.getElementById('her2').value];

            // Calculate individual equations
            const equation1 = (0.93 * nottingham) + (0.08 * erHScore) - (0.09 * prHScore) + 
                            (4.87 * her2Score) + (0.97 * tumorSize) + (0.12 * ki67) - 4.31;
            
            const equation2 = (1.01 * nottingham) + (0.09 * erHScore) - (0.10 * prHScore) + 
                            (5.20 * her2Score) + (1.02 * tumorSize) - 4.34;
            
            const equation3 = (0.07 * erHScore) - (0.09 * prHScore) + 
                            (4.60 * her2Score) + (0.11 * ki67) + 11.36;

            // Calculate average
            const average = (equation1 + equation2 + equation3) / 3;
            
            // Display results
            document.getElementById('averageScore').textContent = average.toFixed(1);
            document.getElementById('interpretation').textContent = getInterpretation(average);
            document.querySelector('.result-alert').style.display = 'block';
        }

        function getInterpretation(score) {
            if (score < 18) return 'Low recurrence risk';
            if (score <= 30) return 'Intermediate recurrence risk';
            return 'High recurrence risk';
        }

        // Input validation for real-time clamping
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                const max = parseFloat(this.max);
                const min = parseFloat(this.min);
                let value = parseFloat(this.value);
                
                if (!isNaN(value)) {
                    if (value > max) this.value = max;
                    if (value < min) this.value = min;
                }
            });
        });
    </script>
</body>
</html>
