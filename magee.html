<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magee Equations Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            min-height: 100vh;
            margin: 0;
        }
        body {
            background: linear-gradient(pink, white);
        }
        .calculator-container { 
            max-width: 800px; 
            margin: 2rem auto; 
            padding: 20px; 
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .form-group { 
            margin-bottom: 1.2rem; 
        }
        .result-alert { 
            display: none; 
            margin-top: 1.5rem; 
        }
        input[type="number"] { 
            max-width: 200px; 
        }
        .accordion-button:not(.collapsed) { 
            color: white;
            background-color: #e83e8c; 
        }
        .accordion-button {
            background-color: #ffb6c1;
            color: #333;
        }
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(232, 62, 140, 0.25);
        }
        pre.bg-light { 
            white-space: pre-wrap; 
        }
        .btn-primary {
            background-color: #e83e8c;
            border-color: #e83e8c;
        }
        .btn-primary:hover,
        .btn-primary:active,
        .btn-primary:focus {
            background-color: #d62e7c;
            border-color: #d62e7c;
        }
        .btn-outline-secondary {
            border-color: #e83e8c;
            color: #e83e8c;
        }
        .btn-outline-secondary:hover {
            background-color: #e83e8c;
            color: white;
        }
        .alert-primary {
            background-color: rgba(232, 62, 140, 0.15);
            border-color: rgba(232, 62, 140, 0.3);
            color: #333;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: #e83e8c;">
        <div class="container-fluid justify-content-center">
            <a class="navbar-brand fw-bold mx-4" href="index.html">Home</a>
            <a class="navbar-brand fw-bold mx-4" href="frequently-used.html">Frequently Used</a>
            <a class="navbar-brand fw-bold mx-4" href="risk-assessment.html">Risk Assessment</a>
            <a class="navbar-brand fw-bold mx-4" href="recurrence-treatment.html">Recurrence/Treatment</a>
            <a class="navbar-brand fw-bold mx-4" href="other-calculators.html">Other Calculators</a>
        </div>
    </nav>

    <div class="calculator-container">
        <h2>Magee Equations Calculator</h2>
        <p>Estimates Oncotype DX recurrence score using pathology data in ER-positive, HER2-negative breast cancer.</p>
        
        <form id="mageeForm">
            <div class="form-group">
                <label>Nottingham Score (3-9)</label>
                <input type="number" class="form-control" id="nottingham" min="3" max="9" step="1" required>
            </div>
            <div class="form-group">
                <label>ER IHC Score (0-300)</label>
                <input type="number" class="form-control" id="erIHC" min="0" max="300" step="1" required>
            </div>
            <div class="form-group">
                <label>PR IHC Score (0-300)</label>
                <input type="number" class="form-control" id="prIHC" min="0" max="300" step="1" required>
            </div>
            <div class="form-group">
                <label>HER2 Status</label>
                <select class="form-control" id="her2" required>
                    <option value="negative">Negative</option>
                    <option value="equivocal">Equivocal</option>
                    <option value="positive">Positive</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tumor Size (cm)</label>
                <input type="number" class="form-control" id="tumorSize" min="0.1" max="10.0" step="0.1" required>
            </div>
            <div class="form-group">
                <label>Ki-67 Index (0-100)</label>
                <input type="number" class="form-control" id="ki67" min="0" max="100" step="0.1" required>
            </div>
            <button type="button" class="btn btn-primary" onclick="calculateMagee()">Calculate</button>
            <button type="button" class="btn btn-outline-secondary ms-2" onclick="window.open('https://pubmed.ncbi.nlm.nih.gov/?term=Magee+Equation', '_blank')">PubMed</button>
        </form>

        <div class="result-alert alert alert-primary" role="alert">
            <h4>Average Score: <span id="averageScore">-</span></h4>
            <p class="mb-0">Equation 1: <span id="eq1"></span></p>
            <p class="mb-0">Equation 2: <span id="eq2"></span></p>
            <p class="mb-0">Equation 3: <span id="eq3"></span></p>
        </div>

        <div class="clinical-info mt-4">
            <div class="accordion" id="clinicalAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#moreInfo" aria-expanded="true">
                            Summary
                        </button>
                    </h2>
                    <div id="moreInfo" class="accordion-collapse collapse show"
                         data-bs-parent="#clinicalAccordion">
                        <div class="accordion-body">
                            <img src="/MageeDecisionAlgorithm.png" alt="Magee Decision Algorithm Flowchart" class="img-fluid mb-3">

                            <h5>Magee Decision Algorithm™</h5>
                            <p>
                                The Magee Decision Algorithm™ helps in triaging cases for molecular testing. Use Magee Equation results and mitotic activity score (part of tumor grading) to triage cases.
                            </p>
                            <ul>
                                <li><strong>Could safely forgo molecular testing:</strong> All scores &lt;18, or 18-25 with mitosis score 1</li>
                                <li><strong>Consider sending:</strong> Any score &gt;25 or 18-25 with mitosis score ≥2</li>
                            </ul>

                            <h5>Background</h5>
                            <p>
                                Oncotype DX® is a commercial assay used to estimate the risk of distant recurrence for patients with ER positive, lymph node negative (or 1-3 positive nodes) breast cancers. It is reported as a numerical score (recurrence score or RS) ranging from 0-100.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function formatResult(val) {
            if (isNaN(val)) return "NA";
            return val.toFixed(2);
        }

        function calculateMagee() {
            const nottingham = Math.min(9, Math.max(3, parseFloat(document.getElementById('nottingham').value) || 0));
            const erIHC = Math.min(300, Math.max(0, parseFloat(document.getElementById('erIHC').value) || 0));
            const prIHC = Math.min(300, Math.max(0, parseFloat(document.getElementById('prIHC').value) || 0));
            const tumorSize = Math.min(10, Math.max(0.1, parseFloat(document.getElementById('tumorSize').value) || 0));
            const ki67 = Math.min(100, Math.max(0, parseFloat(document.getElementById('ki67').value) || 0));
            const her2Status = document.getElementById('her2').value;

            // Calculate individual equations
            const eq1 = 15.31385 + 
                        (nottingham * 1.4055) + 
                        (erIHC * -0.01924) + 
                        (prIHC * -0.02925) + 
                        getHer2Value(her2Status, 1) + 
                        (tumorSize * 0.78677) + 
                        (ki67 * 0.13269);

            const eq2 = 18.8042 + 
                        (nottingham * 2.34123) + 
                        (erIHC * -0.03749) + 
                        (prIHC * -0.03065) + 
                        getHer2Value(her2Status, 2) + 
                        (tumorSize * 0.04267);

            const eq3 = 24.30812 + 
                        (erIHC * -0.02177) + 
                        (prIHC * -0.02884) + 
                        getHer2Value(her2Status, 3) + 
                        (ki67 * 0.18649);

            // Calculate average
            const values = [eq1, eq2, eq3];
            const validValues = values.filter(v => !isNaN(v));
            const average = validValues.length === 3 ? (eq1 + eq2 + eq3) / 3 : NaN;

            // Display results
            document.getElementById('eq1').textContent = formatResult(eq1);
            document.getElementById('eq2').textContent = formatResult(eq2);
            document.getElementById('eq3').textContent = formatResult(eq3);
            document.getElementById('averageScore').textContent = formatResult(average);
            document.querySelector('.result-alert').style.display = 'block';
        }

        function getHer2Value(status, equationNum) {
            const values = {
                1: { negative: 0, equivocal: 0.77681, positive: 11.58134 },
                2: { negative: 0, equivocal: 1.82921, positive: 11.51378 },
                3: { negative: 0, equivocal: 1.46495, positive: 12.75525 }
            };
            return values[equationNum][status];
        }

        // Input validation (real-time clamping)
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                const max = parseFloat(this.max);
                const min = parseFloat(this.min);
                let value = parseFloat(this.value);
                if (!isNaN(value)) {
                    if (value > max) this.value = max;
                    if (value < min) this.value = min;
                }
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
